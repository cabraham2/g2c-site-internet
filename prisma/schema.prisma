// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Promotion {
  id          String   @id @default(cuid())
  name        String   @unique
  year        String?  // Rendu optionnel pour la migration
  level       String   // M1, M2, L3, Alumni, Drop-out, Césure
  isActive    Boolean  @default(true)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  userPromotions UserPromotion[]

  @@map("promotions")
}

model UserPromotion {
  id          String   @id @default(cuid())
  userId      String
  promotionId String
  isActive    Boolean  @default(true) // Si false, l'utilisateur n'a plus accès aux ressources de cette promo
  assignedAt  DateTime @default(now())
  assignedBy  String?

  // Relations
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  promotion  Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  assignedByUser User?  @relation("UserPromotionAssigner", fields: [assignedBy], references: [id])

  @@unique([userId, promotionId])
  @@map("user_promotions")
}

model User {
  id           String      @id @default(cuid())
  email        String      @unique
  password     String
  firstName    String
  lastName     String
  role         UserRole    @default(STUDENT)
  status       UserStatus  @default(PENDING)
  promotion    String?     // Garder pour compatibilité temporaire
  company      String?
  position     String?
  linkedin     String?
  phone        String?
  profilePicture String?   // URL de la photo de profil
  validatedBy  String?
  validatedAt  DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // Relations
  groupMemberships GroupMember[]
  classEnrollments ClassEnrollment[]
  documents        Document[]
  projects         ProjectMember[]
  posts            Post[]
  comments         Comment[]
  gradesReceived   Grade[]         @relation("StudentGrades")
  gradesGiven      Grade[]         @relation("TeacherGrades")
  teacherSubjects  TeacherSubject[]
  validator        User?           @relation("UserValidator", fields: [validatedBy], references: [id])
  validatedUsers   User[]          @relation("UserValidator")
  reports          Report[]
  promotions       UserPromotion[]
  assignedPromotions UserPromotion[] @relation("UserPromotionAssigner")

  @@map("users")
}

model Group {
  id          String   @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  members GroupMember[]
  classes Class[]

  @@map("groups")
}

model GroupMember {
  id     String @id @default(cuid())
  userId String
  groupId String

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
  @@map("group_members")
}

model Class {
  id          String   @id @default(cuid())
  name        String
  description String?
  code        String   @unique
  level       String   // L3, M1, M2
  year        String   // 2024-2025
  groupId     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  group           Group?            @relation(fields: [groupId], references: [id])
  enrollments     ClassEnrollment[]
  documents       Document[]
  projects        Project[]
  subjects        Subject[]
  teacherSubjects TeacherSubject[]

  @@map("classes")
}

model ClassEnrollment {
  id      String @id @default(cuid())
  userId  String
  classId String

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  class Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([userId, classId])
  @@map("class_enrollments")
}

model Document {
  id          String      @id @default(cuid())
  title       String
  description String?
  fileName    String
  fileUrl     String
  fileSize    Int
  mimeType    String
  type        DocumentType @default(COURSE)
  classId     String?
  uploadedById String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  class      Class? @relation(fields: [classId], references: [id])
  uploadedBy User   @relation(fields: [uploadedById], references: [id])

  @@map("documents")
}

model Project {
  id          String   @id @default(cuid())
  title       String
  description String
  deadline    DateTime
  classId     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  class   Class?          @relation(fields: [classId], references: [id])
  members ProjectMember[]

  @@map("projects")
}

model ProjectMember {
  id        String @id @default(cuid())
  userId    String
  projectId String
  role      ProjectRole @default(MEMBER)

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
  @@map("project_members")
}

model Post {
  id        String   @id @default(cuid())
  title     String
  content   String
  authorId  String
  published Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  author   User      @relation(fields: [authorId], references: [id])
  comments Comment[]

  @@map("posts")
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  postId    String
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  post   Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  author User @relation(fields: [authorId], references: [id])

  @@map("comments")
}

model Subject {
  id          String @id @default(cuid())
  name        String
  code        String @unique
  description String?
  coefficient Float  @default(1.0)
  color       String @default("#3B82F6")

  // Relations
  classes         Class[]
  teacherSubjects TeacherSubject[]
  grades          Grade[]

  @@map("subjects")
}

model TeacherSubject {
  id        String @id @default(cuid())
  teacherId String
  subjectId String
  classId   String

  teacher User    @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  class   Class   @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([teacherId, subjectId, classId])
  @@map("teacher_subjects")
}

model Grade {
  id          String    @id @default(cuid())
  value       Float
  maxValue    Float     @default(20.0)
  weight      Float     @default(1.0)
  type        GradeType @default(HOMEWORK)
  title       String
  description String?
  studentId   String
  teacherId   String
  subjectId   String
  classId     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  student User    @relation("StudentGrades", fields: [studentId], references: [id], onDelete: Cascade)
  teacher User    @relation("TeacherGrades", fields: [teacherId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@map("grades")
}

model Report {
  id           String     @id @default(cuid())
  studentId    String
  classId      String?
  semester     String
  year         String
  average      Float?
  rank         Int?
  totalStudents Int?
  appreciation String?
  absences     Int        @default(0)
  status       ReportStatus @default(DRAFT)
  generatedAt  DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relations
  student User @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, semester, year])
  @@map("reports")
}

enum UserStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum GradeType {
  HOMEWORK
  TEST
  EXAM
  PROJECT
  PARTICIPATION
}

enum ReportStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum UserRole {
  STUDENT
  ALUMNI
  TEACHER
  ADMIN
}

enum DocumentType {
  COURSE
  ASSIGNMENT
  RESOURCE
  EXAM
}

enum ProjectRole {
  LEADER
  MEMBER
}
